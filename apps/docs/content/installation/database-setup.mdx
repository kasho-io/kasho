# Database Setup

import { Callout, Tabs } from "nextra/components";

This guide covers the database configuration and user setup required for Kasho. Choose your database type below.

<Tabs items={['PostgreSQL', 'MySQL']}>
<Tabs.Tab>
## PostgreSQL Database Requirements

### Source PostgreSQL Database

Your source database needs:

- **PostgreSQL version:** 15 or higher
- **WAL level:** Set to `logical` for replication
- **Replication slots:** At least 2 available slots
- **Max WAL senders:** At least 2
- **User permissions:** REPLICATION privilege and SELECT on all tables

### Target Database

Your target database needs:

- **PostgreSQL version:** 15 or higher
- **User permissions:** SUPERUSER privilege

<Callout type="warning">
  **SUPERUSER Required** The replica user requires SUPERUSER privileges to set `session_replication_role = 'replica'`,
  which prevents triggers from firing during replication.
</Callout>

## Step 1: Configure PostgreSQL for Logical Replication

<Callout type="warning">Changing these settings requires a PostgreSQL restart</Callout>

Edit your `postgresql.conf` file:

```ini
# Enable logical replication
wal_level = logical

# Allow replication connections
max_replication_slots = 10
max_wal_senders = 10
```

Restart PostgreSQL after making these changes.

## Step 2: Setup Both Databases

### Option A: Automated Setup (Recommended)

Use the provided setup script to configure both primary and replica databases:

```bash
# Set environment variables for both databases
export PRIMARY_DATABASE_URL="postgresql://kasho:pass@primary:5432/db"
export REPLICA_DATABASE_URL="postgresql://kasho:pass@replica:5432/db"
export PRIMARY_DATABASE_SU_USER="postgres"
export PRIMARY_DATABASE_SU_PASSWORD="postgres"
export REPLICA_DATABASE_SU_USER="postgres"
export REPLICA_DATABASE_SU_PASSWORD="postgres"

# Run setup script that configures both databases
docker run --rm kasho:latest /app/scripts/prepare-dbs-pg.sh
```

This script will:

1. Verify prerequisites on the primary (wal_level = logical)
2. Create the kasho user on the primary with REPLICATION privileges
3. Create the kasho user on the replica with SUPERUSER privileges
4. Set up DDL logging on the primary (for schema change replication)
5. Create the publication on the primary

### Option B: Manual Setup

If you prefer manual setup, follow these steps:

#### 1. Verify WAL Level

Connect as a superuser and check:

```sql
-- Check current setting
SHOW wal_level;

-- Should return 'logical'
```

#### 2. Create User on Source Database

```sql
-- Create role with replication and login privileges
CREATE ROLE kasho WITH REPLICATION LOGIN PASSWORD 'your-secure-password';

-- Grant read permissions
GRANT USAGE ON SCHEMA public TO kasho;
GRANT CREATE ON SCHEMA public TO kasho;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO kasho;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO kasho;

-- Grant future table permissions
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT ON TABLES TO kasho;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT ON SEQUENCES TO kasho;
```

#### 3. Create User on Target Database

Connect as a superuser to your target database:

```sql
-- Create role with SUPERUSER privileges
-- SUPERUSER is required to set session_replication_role = 'replica'
CREATE ROLE kasho WITH SUPERUSER LOGIN PASSWORD 'your-secure-password';

-- Grant full permissions (needs to apply changes)
GRANT USAGE ON SCHEMA public TO kasho;
GRANT CREATE ON SCHEMA public TO kasho;
GRANT ALL ON ALL TABLES IN SCHEMA public TO kasho;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO kasho;

-- Grant future table permissions
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL ON TABLES TO kasho;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL ON SEQUENCES TO kasho;
```

#### 4. Create Publication on Source

```sql
-- Create publication for all tables
CREATE PUBLICATION kasho_pub FOR ALL TABLES;
```

<Callout type="info">
  Do NOT create the replication slot manually. It will be created automatically during the bootstrap process.
</Callout>

## Step 3: Configure pg_hba.conf

Ensure the kasho user can connect for replication. Add to `pg_hba.conf`:

```
# TYPE  DATABASE        USER        ADDRESS                 METHOD
host    replication     kasho       0.0.0.0/0               md5
host    all             kasho       0.0.0.0/0               md5
```

Reload PostgreSQL configuration:

```bash
pg_ctl reload
```

## Step 4: Test Connection

Verify the kasho user can connect:

```bash
# Test source database connection
psql "postgresql://kasho:password@source-host:5432/source_db?sslmode=disable" -c "SELECT 1"

# Test target database connection
psql "postgresql://kasho:password@target-host:5432/target_db?sslmode=disable" -c "SELECT 1"
```

<Callout type="info">
  **Security Consideration** The replica user requires SUPERUSER privileges. In production environments, this should be
  carefully evaluated. Consider using a dedicated database instance for the replica if security policies restrict
  SUPERUSER access.
</Callout>

## Step 5: DDL Replication Setup

In order to replicate schema changes (CREATE TABLE, ALTER TABLE, etc.), you must set up DDL logging:

```sql
-- Create DDL log table
CREATE TABLE IF NOT EXISTS kasho_ddl_log (
    id BIGSERIAL PRIMARY KEY,
    lsn pg_lsn NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    username TEXT NOT NULL,
    database TEXT NOT NULL,
    ddl TEXT NOT NULL
);

-- Create cleanup function
CREATE OR REPLACE FUNCTION kasho_cleanup_ddl_log() RETURNS void AS $$
BEGIN
    DELETE FROM kasho_ddl_log WHERE timestamp < NOW() - INTERVAL '7 days';
END;
$$ LANGUAGE plpgsql;

-- Create DDL capture function
CREATE OR REPLACE FUNCTION kasho_log_ddl() RETURNS event_trigger AS $$
DECLARE
    current_lsn pg_lsn;
    ddl_text TEXT;
BEGIN
    SELECT pg_current_wal_lsn() INTO current_lsn;
    SELECT current_query() INTO ddl_text;

    INSERT INTO kasho_ddl_log (lsn, username, database, ddl)
    VALUES (current_lsn, current_user, current_database(), ddl_text);

    PERFORM kasho_cleanup_ddl_log();
END;
$$ LANGUAGE plpgsql;

-- Create event triggers
CREATE EVENT TRIGGER kasho_log_ddl_start
ON ddl_command_start
EXECUTE FUNCTION kasho_log_ddl();

CREATE EVENT TRIGGER kasho_log_ddl_end
ON ddl_command_end
EXECUTE FUNCTION kasho_log_ddl();
```
</Tabs.Tab>
<Tabs.Tab>
## MySQL Database Requirements

### Source MySQL Database

Your source database needs:

- **MySQL version:** 8.0 or higher
- **Binary logging:** Enabled with ROW format
- **GTID mode:** Enabled for consistent replication
- **User permissions:** REPLICATION SLAVE, REPLICATION CLIENT, and SELECT privileges

### Target Database

Your target database needs:

- **MySQL version:** 8.0 or higher
- **User permissions:** ALL PRIVILEGES (required to bypass foreign key checks during replication)

<Callout type="info">
  **Simpler DDL Replication** Unlike PostgreSQL, MySQL automatically captures DDL statements in the binary log. No
  additional DDL logging setup is required.
</Callout>

## Step 1: Configure MySQL for Binary Log Replication

<Callout type="warning">Changing these settings requires a MySQL restart</Callout>

Edit your `my.cnf` file:

```ini
[mysqld]
# Unique server identifier
server-id = 1

# Enable binary logging
log_bin = mysql-bin

# Full row images for accurate replication
binlog_row_image = FULL

# Enable GTID mode for consistent replication
gtid_mode = ON
enforce_gtid_consistency = ON
```

<Callout type="info">
  **Note:** `binlog_format = ROW` defaults in MySQL 8.0+ and the option is deprecated, so you don't need to set it
  explicitly.
</Callout>

Restart MySQL after making these changes.

## Step 2: Setup Both Databases

### Option A: Automated Setup (Recommended)

Use the provided setup script to configure both primary and replica databases:

```bash
# Set environment variables for both databases
export PRIMARY_DATABASE_URL="mysql://kasho:pass@primary:3306/db"
export REPLICA_DATABASE_URL="mysql://kasho:pass@replica:3306/db"
export PRIMARY_DATABASE_SU_USER="root"
export PRIMARY_DATABASE_SU_PASSWORD="root"
export REPLICA_DATABASE_SU_USER="root"
export REPLICA_DATABASE_SU_PASSWORD="root"

# Run setup script that configures both databases
docker run --rm kasho:latest /app/scripts/prepare-dbs-mysql.sh
```

This script will:

1. Verify prerequisites on the primary (binlog enabled, GTID mode)
2. Create the kasho user on the primary with REPLICATION privileges
3. Create the kasho user on the replica with ALL PRIVILEGES

### Option B: Manual Setup

If you prefer manual setup, follow these steps:

#### 1. Verify Binary Logging

Connect as root and check:

```sql
-- Check current settings
SELECT
    @@binlog_format AS binlog_format,
    @@log_bin AS log_bin_enabled,
    @@binlog_row_image AS binlog_row_image,
    @@gtid_mode AS gtid_mode;

-- Expected values:
-- binlog_format = ROW
-- log_bin_enabled = 1
-- binlog_row_image = FULL
-- gtid_mode = ON
```

#### 2. Create User on Source Database

```sql
-- Create user with replication privileges
CREATE USER 'kasho'@'%' IDENTIFIED BY 'your-secure-password';

-- Grant replication privileges
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'kasho'@'%';

-- Grant SELECT on all tables for reading data
GRANT SELECT ON *.* TO 'kasho'@'%';

-- Apply privileges
FLUSH PRIVILEGES;
```

#### 3. Create User on Target Database

Connect as root to your target database:

```sql
-- Create user with full privileges
CREATE USER 'kasho'@'%' IDENTIFIED BY 'your-secure-password';

-- Grant all privileges (needed to apply changes and bypass foreign key checks)
GRANT ALL PRIVILEGES ON *.* TO 'kasho'@'%' WITH GRANT OPTION;

-- Apply privileges
FLUSH PRIVILEGES;
```

<Callout type="info">
  **No Publication Required** Unlike PostgreSQL, MySQL doesn't require creating a publication. The binary log
  automatically captures all changes.
</Callout>

## Step 3: Grant User Privileges

MySQL uses GRANT statements for access control instead of a separate configuration file like PostgreSQL's pg_hba.conf.

The user creation statements above already include `'kasho'@'%'` which allows connections from any host. For production, you may want to restrict this:

```sql
-- Restrict to specific host/network
CREATE USER 'kasho'@'10.0.0.%' IDENTIFIED BY 'your-secure-password';

-- Or restrict to specific IP
CREATE USER 'kasho'@'192.168.1.100' IDENTIFIED BY 'your-secure-password';
```

## Step 4: Test Connection

Verify the kasho user can connect:

```bash
# Test source database connection
mysql -h source-host -P 3306 -u kasho -p -e "SELECT 1"

# Test target database connection
mysql -h target-host -P 3306 -u kasho -p -e "SELECT 1"

# Verify binlog access on source
mysql -h source-host -P 3306 -u kasho -p -e "SHOW MASTER STATUS"
```

<Callout type="info">
  **Security Consideration** The replica user requires ALL PRIVILEGES. In production environments, consider using a
  dedicated database instance for the replica if security policies are a concern.
</Callout>

<Callout type="info">
  **No DDL Setup Required** MySQL automatically captures DDL statements (CREATE TABLE, ALTER TABLE, etc.) in the binary
  log. Unlike PostgreSQL, no additional event triggers or logging tables are needed.
</Callout>
</Tabs.Tab>
</Tabs>

## Next Steps

Once your databases are configured:

1. Continue with the [Quick Start](/quick-start) guide
2. Learn about [Configuration Options](/installation/configuration)
3. Set up the [Bootstrap Process](/installation/bootstrap) for existing data
