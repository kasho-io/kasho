import { Tabs } from "nextra/components";

# Configuration

Kasho uses environment variables for service configuration and a YAML file for transformation rules.

## Environment Variables

<Tabs items={['PostgreSQL', 'MySQL']}>
<Tabs.Tab>
### `pg-change-stream` Configuration

| Variable               | Description                    | Required | Example                               |
| ---------------------- | ------------------------------ | -------- | ------------------------------------- |
| `KV_URL`               | Redis connection URL           | Yes      | `redis://redis:6379`                  |
| `PRIMARY_DATABASE_URL` | Source database connection URL | Yes      | `postgresql://user:pass@host:5432/db` |

### `translicator` Configuration

| Variable                     | Description                        | Required | Example                               |
| ---------------------------- | ---------------------------------- | -------- | ------------------------------------- |
| `CHANGE_STREAM_SERVICE_ADDR` | `pg-change-stream` service address | Yes      | `pg-change-stream:50051`              |
| `REPLICA_DATABASE_URL`       | Target database connection URL     | Yes      | `postgresql://user:pass@host:5432/db` |

### `pg-bootstrap-sync` Configuration

`pg-bootstrap-sync` uses command-line flags for configuration. See the [Bootstrap Process](/installation/bootstrap) guide for details.
</Tabs.Tab>
<Tabs.Tab>
### `mysql-change-stream` Configuration

| Variable               | Description                    | Required | Example                            |
| ---------------------- | ------------------------------ | -------- | ---------------------------------- |
| `KV_URL`               | Redis connection URL           | Yes      | `redis://redis:6379`               |
| `PRIMARY_DATABASE_URL` | Source database connection URL | Yes      | `mysql://user:pass@host:3306/db`   |

### `translicator` Configuration

| Variable                     | Description                          | Required | Example                          |
| ---------------------------- | ------------------------------------ | -------- | -------------------------------- |
| `CHANGE_STREAM_SERVICE_ADDR` | `mysql-change-stream` service address | Yes      | `mysql-change-stream:50051`      |
| `REPLICA_DATABASE_URL`       | Target database connection URL       | Yes      | `mysql://user:pass@host:3306/db` |

### `mysql-bootstrap-sync` Configuration

`mysql-bootstrap-sync` uses command-line flags for configuration. See the [Bootstrap Process](/installation/bootstrap) guide for details.
</Tabs.Tab>
</Tabs>

## Database URL Format

<Tabs items={['PostgreSQL', 'MySQL']}>
<Tabs.Tab>
Database URLs follow the standard PostgreSQL connection string format:

```
postgresql://[user[:password]@][host][:port][/database][?param=value&...]
```

### Common Parameters

- **`sslmode`** - SSL connection mode
  - `disable` - No SSL
  - `require` - SSL required
  - `verify-ca` - SSL with CA verification
  - `verify-full` - SSL with full verification
- **`connect_timeout`** - Connection timeout in seconds (default: 30)
- **`application_name`** - Identifies your application in pg_stat_activity

### Examples

```bash
# Basic connection without SSL
postgresql://kasho:mypassword@localhost:5432/mydb?sslmode=disable

# Connection with SSL required
postgresql://kasho:mypassword@prod-db.example.com:5432/mydb?sslmode=require

# Connection with timeout and app name
postgresql://kasho:mypassword@db:5432/mydb?connect_timeout=10&application_name=kasho
```
</Tabs.Tab>
<Tabs.Tab>
Database URLs follow the standard MySQL connection string format:

```
mysql://[user[:password]@][host][:port][/database][?param=value&...]
```

### Common Parameters

- **`tls`** - TLS/SSL connection mode
  - `false` - No TLS
  - `true` - TLS required
  - `skip-verify` - TLS without certificate verification
- **`timeout`** - Connection timeout (e.g., `10s`, `30s`)
- **`parseTime`** - Parse time values to `time.Time` (set to `true`)

### Examples

```bash
# Basic connection without TLS
mysql://kasho:mypassword@localhost:3306/mydb?tls=false

# Connection with TLS required
mysql://kasho:mypassword@prod-db.example.com:3306/mydb?tls=true

# Connection with timeout and time parsing
mysql://kasho:mypassword@db:3306/mydb?timeout=10s&parseTime=true
```
</Tabs.Tab>
</Tabs>

## Transform Configuration

`translicator` requires a `transforms.yml` file that defines how data should be transformed during replication.

### File Location

The transforms file must be mounted at `/app/config/transforms.yml` in the `translicator` container. How you mount this file depends on your deployment platform:

- **Kubernetes**: ConfigMap or Volume mount
- **ECS**: Task definition with mounted file from S3 or EFS
- **Docker**: Direct volume mount
- **Other platforms**: Use your platform's file mounting mechanism

### Basic Structure

```yaml
version: v1
tables:
  schema.table_name:
    column_name: TransformationType
```

### Example Configuration

```yaml
version: v1
tables:
  public.users:
    email: FakeEmail
    phone: FakePhone
    address: FakeStreetAddress

  public.orders:
    customer_email: FakeEmail
    billing_address: FakeStreetAddress
```

See the [Transform Configuration](/configuration/transforms) guide for detailed information about available transforms.

## Production Deployment

For production deployments, mount the transforms configuration using your orchestration platform's configuration management:

- **Kubernetes**: Use ConfigMaps or mounted volumes
- **ECS**: Use task definition volumes with S3 or EFS
- **Docker Swarm**: Use configs or secrets
- **Other platforms**: Follow your platform's configuration mounting practices

The key requirement is that `transforms.yml` must be available at `/app/config/transforms.yml` inside the translicator container.

## Configuration Best Practices

1. **Use Environment Files**
   - Keep sensitive data in `.env` files
   - Never commit `.env` files to version control
   - Use `.env.example` as a template

2. **Security**
   - Use strong passwords for database users
   - Enable SSL for production deployments
   - Restrict network access to services

3. **Monitoring**
   - Check change-stream service status: `grpcurl -plaintext <host>:50051 kasho.ChangeStreamService/GetStatus`
   - Check service logs regularly
   - For PostgreSQL: Monitor replication slot status with `SELECT * FROM pg_replication_slots WHERE slot_name = 'kasho_slot'`
   - For MySQL: Monitor binlog position with `SHOW MASTER STATUS`

## Next Steps

- Set up the [Bootstrap Process](/installation/bootstrap) for existing data
- Configure [Data Transforms](/configuration/transforms)
- Review the [Quick Start](/quick-start) guide
