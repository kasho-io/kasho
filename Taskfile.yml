version: '3'

tasks:
  default:
    desc: List all available tasks
    cmds:
      - task --list

  build:
    desc: Build the kasho Docker image for development
    cmds:
      - docker build -t kasho --target development .

  proto:
    desc: Generate Go code from protobuf definitions
    cmds:
      - protoc --go_out=proto/kasho --go_opt=paths=source_relative --go-grpc_out=proto/kasho --go-grpc_opt=paths=source_relative proto/change_stream.proto

  test:
    desc: Run all tests (Go services + Next.js apps)
    deps: [test:go, test:apps]
    cmds:
      - echo "âœ… All tests passed!"

  test:go:
    desc: Run tests for all Go services and packages
    deps: [proto]
    cmds:
      - task: test:kvbuffer
      - task: test:pg-change-stream
      - task: test:pg-translicator
      - task: test:pg-bootstrap-sync
      - task: test:env-template
      - task: test:proto

  test:pg-change-stream:
    desc: Run tests for pg-change-stream service
    dir: services/pg-change-stream
    cmds:
      - echo "ğŸ§ª Testing pg-change-stream..."
      - go test -v -race -coverprofile=coverage.out ./...
      - go tool cover -func=coverage.out

  test:pg-translicator:
    desc: Run tests for pg-translicator service
    dir: services/pg-translicator
    cmds:
      - echo "ğŸ§ª Testing pg-translicator..."
      - go test -v -race -coverprofile=coverage.out ./...
      - go tool cover -func=coverage.out

  test:kvbuffer:
    desc: Run tests for shared kvbuffer package
    dir: pkg/kvbuffer
    cmds:
      - echo "ğŸ§ª Testing kvbuffer package..."
      - go test -v -race -coverprofile=coverage.out ./...
      - go tool cover -func=coverage.out

  test:pg-bootstrap-sync:
    desc: Run tests for pg-bootstrap-sync tool
    dir: tools/pg-bootstrap-sync
    cmds:
      - echo "ğŸ§ª Testing pg-bootstrap-sync..."
      - go test -v -race -coverprofile=coverage.out ./...
      - go tool cover -func=coverage.out

  test:env-template:
    desc: Run tests for env-template tool
    dir: tools/env-template
    cmds:
      - echo "ğŸ§ª Testing env-template..."
      - go test -v -race .

  test:proto:
    desc: Test proto package (validates compilation)
    dir: proto/kasho/proto
    cmds:
      - echo "ğŸ§ª Testing proto package..."
      - go test -v -race .

  test:apps:
    desc: Run tests for all Next.js apps
    cmds:
      - task: test:app-demo
      - task: test:app-homepage

  test:app-demo:
    desc: Run tests for demo app
    dir: apps/demo
    cmds:
      - echo "ğŸ§ª Testing demo app..."
      - npm run test

  test:app-homepage:
    desc: Run tests for homepage app
    dir: apps/homepage
    cmds:
      - echo "ğŸ§ª Testing homepage app..."
      - npm run test

  dev:
    desc: Start development environment (alias for dev:start)
    deps: [dev:start]

  dev:start:
    desc: Start development environment
    deps: [build]
    cmds:
      - cd environments/development && docker-compose up

  dev:stop:
    desc: Stop development environment and remove volumes
    cmds:
      - cd environments/development && docker-compose down -v

  dev:reset:
    desc: Reset and restart development environment (removes volumes)
    deps: [dev:stop, dev:start]

  dev:setup-replication:
    desc: Setup replication for the development environment
    cmds:
      - ./scripts/setup-replication.sh

  dev:setup-data:
    desc: Setup fake SaaS data for the development environment
    cmds:
      - ./scripts/demo-fake-projmgmt-saas.sh

  dev:app-demo:
    desc: Start the demo app
    cmds:
      - cd apps/demo && npm run dev

  dev:app-homepage:
    desc: Start the homepage app
    cmds:
      - cd apps/homepage && npm run dev

  # Lint tasks
  lint:
    desc: Run linting for all code
    cmds:
      - task: lint:go
      - task: lint:apps

  lint:go:
    desc: Run linting for Go services and packages
    cmds:
      - echo "ğŸ” Linting Go code..."
      - cd pkg/kvbuffer && go vet ./...
      - cd services/pg-change-stream && go vet ./...
      - cd services/pg-translicator && go vet ./...
      - cd tools/pg-bootstrap-sync && go vet ./...
      - cd tools/env-template && go vet ./...
      - cd proto/kasho/proto && go vet ./...

  lint:apps:
    desc: Run linting for Next.js apps
    cmds:
      - task: lint:app-demo
      - task: lint:app-homepage

  lint:app-demo:
    desc: Lint demo app
    dir: apps/demo
    cmds:
      - echo "ğŸ” Linting demo app..."
      - npm run lint

  lint:app-homepage:
    desc: Lint homepage app
    dir: apps/homepage
    cmds:
      - echo "ğŸ” Linting homepage app..."
      - npm run lint

  # CI tasks (what CI/CD uses)
  ci:test:
    desc: Run tests with CI-specific options
    deps: [proto]
    cmds:
      - task: ci:test:go
      - task: ci:test:apps

  ci:test:go:
    desc: Run Go tests with coverage for CI
    cmds:
      - cd pkg/kvbuffer && go test -v -race -coverprofile=coverage.out ./...
      - cd services/pg-change-stream && go test -v -race -coverprofile=coverage.out ./...
      - cd services/pg-translicator && go test -v -race -coverprofile=coverage.out ./...
      - cd tools/pg-bootstrap-sync && go test -v -race -coverprofile=coverage.out ./...
      - cd tools/env-template && go test -v -race -coverprofile=coverage.out .
      - cd proto/kasho/proto && go test -v -race -coverprofile=coverage.out .

  ci:test:apps:
    desc: Run Next.js app tests for CI
    cmds:
      - cd apps/demo && npm ci && npm run test:ci
      - cd apps/homepage && npm ci && npm run test:ci
