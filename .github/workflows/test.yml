name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      force_all_tests:
        description: 'Force all tests to run regardless of changes'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: read

jobs:
  # Job to determine which parts of the codebase have changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      go-services: ${{ steps.changes.outputs.go-services }}
      proto: ${{ steps.changes.outputs.proto }}
      changed-apps: ${{ steps.detect-apps.outputs.changed-apps }}
      all-apps: ${{ steps.detect-apps.outputs.all-apps }}
    steps:
      - uses: actions/checkout@v4
      
      # Detect Go services and proto changes
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            go-services:
              - 'services/**'
              - 'tools/**'
              - 'pkg/**'
              - 'proto/**'
              - 'go.work'
              - 'go.work.sum'
            proto:
              - 'proto/**'
      
      # Dynamically detect all apps and which ones changed
      - name: Detect apps
        id: detect-apps
        run: |
          # Get all apps
          ALL_APPS=$(find apps -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "all-apps=$ALL_APPS" >> $GITHUB_OUTPUT
          
          # Detect which apps have changes
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, check what changed
            echo "Detecting changes for PR from origin/${{ github.base_ref }}...HEAD"
            CHANGED_FILES=$((git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^apps/' || true) | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            # For pushes, check the last commit
            echo "Detecting changes for push in HEAD~1...HEAD"
            CHANGED_FILES=$((git diff --name-only HEAD~1...HEAD | grep '^apps/' || true) | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          
          # Debug output
          echo "Raw changed files:"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20
          else
            git diff --name-only HEAD~1...HEAD | head -20
          fi
          
          if [ -z "$CHANGED_FILES" ] || [ "$CHANGED_FILES" == "[]" ]; then
            echo "changed-apps=[]" >> $GITHUB_OUTPUT
          else
            echo "changed-apps=$CHANGED_FILES" >> $GITHUB_OUTPUT
          fi
          
          echo "All apps: $ALL_APPS"
          echo "Changed apps: $CHANGED_FILES"
      
      - name: Save change detection results for publish workflow
        if: github.ref == 'refs/heads/main'
        run: |
          # Properly evaluate docker_changes as a boolean
          if [[ "${{ steps.changes.outputs.go-services }}" == "true" ]] || [[ "${{ steps.changes.outputs.proto }}" == "true" ]]; then
            DOCKER_CHANGES="true"
          else  
            DOCKER_CHANGES="false"
          fi
          
          cat > change-detection.json << EOF
          {
            "docker_changes": "$DOCKER_CHANGES",
            "go_services": "${{ steps.changes.outputs.go-services }}",
            "proto": "${{ steps.changes.outputs.proto }}",
            "changed_apps": ${{ steps.detect-apps.outputs.changed-apps }},
            "all_apps": ${{ steps.detect-apps.outputs.all-apps }}
          }
          EOF
          
      - name: Upload change detection artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: change-detection
          path: change-detection.json
          retention-days: 1

  # Test Go services (pg-change-stream, pg-translicator)
  test-go-services:
    needs: detect-changes
    if: needs.detect-changes.outputs.go-services == 'true' || github.event.inputs.force_all_tests == 'true'
    uses: ./.github/workflows/test-go-services.yml

  # Test all Next.js apps dynamically
  test-apps:
    needs: detect-changes
    # Always run tests on PRs, or when apps change, or when forced
    if: |
      github.event_name == 'pull_request' ||
      needs.detect-changes.outputs.changed-apps != '[]' || 
      github.event.inputs.force_all_tests == 'true'
    strategy:
      matrix:
        app: ${{ (github.event_name == 'pull_request' || github.event.inputs.force_all_tests == 'true') && fromJson(needs.detect-changes.outputs.all-apps) || fromJson(needs.detect-changes.outputs.changed-apps) }}
    uses: ./.github/workflows/test-nextjs-app.yml
    with:
      app-directory: apps/${{ matrix.app }}
      app-name: ${{ matrix.app }}

  # Validate protobuf definitions
  test-proto:
    needs: detect-changes
    if: needs.detect-changes.outputs.proto == 'true' || github.event.inputs.force_all_tests == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Protocol Buffers
        uses: arduino/setup-protoc@v2
        with:
          version: '29.3'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - name: Install protoc-gen-go
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
      - name: Validate proto compilation
        run: |
          protoc --go_out=proto/kasho --go_opt=paths=source_relative \
                 --go-grpc_out=proto/kasho --go-grpc_opt=paths=source_relative \
                 proto/change_stream.proto
          # Check if generated files match committed files
          git diff --exit-code proto/kasho/proto/ || (echo "Proto files are not up to date. Run 'task proto' and commit changes." && exit 1)

  # Summary job that all other workflows depend on
  test-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-go-services, test-apps, test-proto]
    if: always()
    steps:
      - name: Check test results
        run: |
          # Check if any required jobs failed
          if [[ "${{ needs.test-go-services.result }}" == "failure" ]]; then
            echo "Go services tests failed"
            exit 1
          fi
          if [[ "${{ needs.test-apps.result }}" == "failure" ]]; then
            echo "App tests failed"
            exit 1
          fi
          if [[ "${{ needs.test-proto.result }}" == "failure" ]]; then
            echo "Proto validation failed"
            exit 1
          fi
          echo "All tests passed!"

