name: Deploy Demo Environment

on:
  workflow_run:
    workflows: ["Test Suite"]
    types:
      - completed
    branches:
      - main

jobs:
  check-changes:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.demo }}
    steps:
      - uses: actions/checkout@v4
      - name: Check for relevant changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            demo:
              - 'environments/demo/**'
              - 'tools/**'
              - 'services/**'
              - '.github/workflows/deploy-demo.yml'

  deploy:
    needs: check-changes
    if: ${{ github.event.workflow_run.conclusion == 'success' && needs.check-changes.outputs.should-deploy == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log deployment start
        run: |
          echo "ðŸš€ Starting deployment to DigitalOcean..."
          echo "Tests passed: ${{ github.event.workflow_run.conclusion == 'success' }}"
          echo "Should deploy: ${{ needs.check-changes.outputs.should-deploy }}"
      
      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd ~
            if [ ! -d "kasho" ]; then
              git clone ${{ secrets.REPO_URL }} kasho
            fi
            cd kasho
            git fetch --all
            git reset --hard origin/main
            git pull -f
            
            # Build the kasho image for production
            docker build -t kasho --target production .
            
            cd environments/demo
            
            # Create .env file from secrets
            cat > .env << EOL
            # Redis connection for pg-change-stream
            KV_URL=${{ secrets.KV_URL }}
            
            # Change stream service for pg-translicator
            CHANGE_STREAM_SERVICE=${{ secrets.CHANGE_STREAM_SERVICE }}
            
            # Primary database URL for pg-change-stream
            PRIMARY_DATABASE_URL=${{ secrets.PRIMARY_DATABASE_URL }}
            
            # Replica database URL for pg-translicator
            REPLICA_DATABASE_URL=${{ secrets.REPLICA_DATABASE_URL }}
            
            # Database configuration for docker-compose PostgreSQL containers
            PRIMARY_DATABASE_SU_USER=${{ secrets.PRIMARY_DATABASE_SU_USER }}
            PRIMARY_DATABASE_SU_PASSWORD=${{ secrets.PRIMARY_DATABASE_SU_PASSWORD }}
            PRIMARY_DATABASE_DB=${{ secrets.PRIMARY_DATABASE_DB }}
            REPLICA_DATABASE_SU_USER=${{ secrets.REPLICA_DATABASE_SU_USER }}
            REPLICA_DATABASE_SU_PASSWORD=${{ secrets.REPLICA_DATABASE_SU_PASSWORD }}
            REPLICA_DATABASE_DB=${{ secrets.REPLICA_DATABASE_DB }}
            EOL
            
            docker compose down -v
            docker compose up --build -d
            
            # Wait for services to start
            sleep 10
            
            # Verify critical services are running
            echo "ðŸ” Checking service status..."
            docker compose ps --format "table {{.Name}}\t{{.Status}}"
            
            # Check pg-change-stream service
            if ! docker compose ps pg-change-stream | grep -q "Up"; then
              echo "âŒ pg-change-stream failed to start"
              echo "ðŸ“‹ pg-change-stream logs:"
              docker compose logs --tail=50 pg-change-stream
              exit 1
            else
              echo "âœ… pg-change-stream is running"
            fi
            
            # Check pg-translicator service
            if ! docker compose ps pg-translicator | grep -q "Up"; then
              echo "âŒ pg-translicator failed to start"
              echo "ðŸ“‹ pg-translicator logs:"
              docker compose logs --tail=50 pg-translicator
              exit 1
            else
              echo "âœ… pg-translicator is running"
            fi
            
            # Check database services
            if ! docker compose ps postgres-primary | grep -q "Up"; then
              echo "âŒ postgres-primary failed to start"
              docker compose logs --tail=30 postgres-primary
              exit 1
            else
              echo "âœ… postgres-primary is running"
            fi
            
            if ! docker compose ps postgres-replica | grep -q "Up"; then
              echo "âŒ postgres-replica failed to start"
              docker compose logs --tail=30 postgres-replica
              exit 1
            else
              echo "âœ… postgres-replica is running"
            fi
            
            # Check redis service
            if ! docker compose ps redis | grep -q "Up"; then
              echo "âŒ redis failed to start"
              docker compose logs --tail=30 redis
              exit 1
            else
              echo "âœ… redis is running"
            fi
            
            echo "ðŸŽ‰ All services are running successfully"
            
            # Run setup scripts
            cd ../..
            ./scripts/setup-replication.sh demo
            ./scripts/demo-fake-projmgmt-saas.sh demo

  deployment-status:
    runs-on: ubuntu-latest
    needs: [check-changes, deploy]
    if: always()
    steps:
      - name: Deployment Status
        run: |
          echo "ðŸ“Š Deployment Status Report"
          echo "=========================="
          echo "Tests passed: ${{ github.event.workflow_run.conclusion == 'success' }}"
          echo "Changes detected: ${{ needs.check-changes.outputs.should-deploy }}"
          echo "Deployment job status: ${{ needs.deploy.result }}"
          
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "âŒ Deployment skipped: Tests failed"
          elif [[ "${{ needs.check-changes.outputs.should-deploy }}" != "true" ]]; then
            echo "â­ï¸ Deployment skipped: No relevant changes detected"
          elif [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… Deployment completed successfully"
          else
            echo "âŒ Deployment failed"
          fi