name: Deploy Demo Environment

on:
  workflow_run:
    workflows: ["Test Suite"]
    types:
      - completed
    branches:
      - main

jobs:
  check-changes:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.demo }}
    steps:
      - uses: actions/checkout@v4
      - name: Check for relevant changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            demo:
              - 'environments/demo/**'
              - 'tools/**'
              - 'services/**'
              - '.github/workflows/deploy-demo.yml'

  deploy:
    needs: check-changes
    if: ${{ github.event.workflow_run.conclusion == 'success' && needs.check-changes.outputs.should-deploy == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log deployment start
        run: |
          echo "üöÄ Starting deployment to DigitalOcean..."
          echo "Tests passed: ${{ github.event.workflow_run.conclusion == 'success' }}"
          echo "Should deploy: ${{ needs.check-changes.outputs.should-deploy }}"
      
      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd ~
            
            # Remove existing repository to ensure clean state
            if [ -d "kasho" ]; then
              echo "Removing existing kasho directory..."
              rm -rf kasho
            fi
            
            # Clone fresh copy of the repository
            echo "Cloning fresh repository..."
            git clone ${{ secrets.REPO_URL }} kasho
            cd kasho
            
            # Install Task if not present
            if ! command -v task &> /dev/null; then
              echo "Installing Task..."
              curl -sL https://taskfile.dev/install.sh | sh
              # Use user's local bin instead of system-wide (no sudo needed)
              mkdir -p ~/.local/bin
              mv ./bin/task ~/.local/bin/task
              export PATH="$HOME/.local/bin:$PATH"
            fi
            
            # Build the kasho base image and production image using Task
            task build:base
            task build:prod
            
            cd environments/demo
            
            # Create .env file from secrets
            cat > .env << EOL
            # User and group IDs for file permissions
            UID=$(id -u)
            GID=$(id -g)
            
            # Redis connection for pg-change-stream
            KV_URL=${{ secrets.KV_URL }}
            
            # Change stream service for pg-translicator
            CHANGE_STREAM_SERVICE=${{ secrets.CHANGE_STREAM_SERVICE }}
            
            # Primary database URL for pg-change-stream
            PRIMARY_DATABASE_URL=${{ secrets.PRIMARY_DATABASE_URL }}
            
            # Replica database URL for pg-translicator
            REPLICA_DATABASE_URL=${{ secrets.REPLICA_DATABASE_URL }}
            
            # Database configuration for docker-compose PostgreSQL containers
            PRIMARY_DATABASE_SU_USER=${{ secrets.PRIMARY_DATABASE_SU_USER }}
            PRIMARY_DATABASE_SU_PASSWORD=${{ secrets.PRIMARY_DATABASE_SU_PASSWORD }}
            PRIMARY_DATABASE_DB=${{ secrets.PRIMARY_DATABASE_DB }}
            REPLICA_DATABASE_SU_USER=${{ secrets.REPLICA_DATABASE_SU_USER }}
            REPLICA_DATABASE_SU_PASSWORD=${{ secrets.REPLICA_DATABASE_SU_PASSWORD }}
            REPLICA_DATABASE_DB=${{ secrets.REPLICA_DATABASE_DB }}
            EOL
            
            docker compose down -v
            docker compose up --build -d
            
            # Wait for services to start
            sleep 10
            
            # Verify critical services are running
            echo "üîç Checking service status..."
            docker compose ps --format "table {{.Name}}\t{{.Status}}"
            
            # Check pg-change-stream service
            if ! docker compose ps pg-change-stream | grep -q "Up"; then
              echo "‚ùå pg-change-stream failed to start"
              echo "üìã pg-change-stream logs:"
              docker compose logs --tail=50 pg-change-stream
              exit 1
            else
              echo "‚úÖ pg-change-stream is running"
            fi
            
            # Check pg-translicator service
            if ! docker compose ps pg-translicator | grep -q "Up"; then
              echo "‚ùå pg-translicator failed to start"
              echo "üìã pg-translicator logs:"
              docker compose logs --tail=50 pg-translicator
              exit 1
            else
              echo "‚úÖ pg-translicator is running"
            fi
            
            # Check database services
            if ! docker compose ps postgres-primary | grep -q "Up"; then
              echo "‚ùå postgres-primary failed to start"
              docker compose logs --tail=30 postgres-primary
              exit 1
            else
              echo "‚úÖ postgres-primary is running"
            fi
            
            if ! docker compose ps postgres-replica | grep -q "Up"; then
              echo "‚ùå postgres-replica failed to start"
              docker compose logs --tail=30 postgres-replica
              exit 1
            else
              echo "‚úÖ postgres-replica is running"
            fi
            
            # Check redis service
            if ! docker compose ps redis | grep -q "Up"; then
              echo "‚ùå redis failed to start"
              docker compose logs --tail=30 redis
              exit 1
            else
              echo "‚úÖ redis is running"
            fi
            
            echo "üéâ All services are running successfully"
            
            # Wait for pg-change-stream to be ready
            echo "‚è≥ Waiting for pg-change-stream to be ready..."
            for i in {1..30}; do
              if docker exec demo-pg-change-stream-1 nc -z localhost 8080 2>/dev/null; then
                echo "‚úÖ pg-change-stream is ready"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "‚ùå pg-change-stream failed to become ready"
                exit 1
              fi
              sleep 2
            done
            
            # Run bootstrap process
            echo "üöÄ Starting Kasho bootstrap process..."
            cd ../..
            
            # Check if bootstrap script exists
            if [ ! -f "./scripts/bootstrap-kasho.sh" ]; then
              echo "‚ùå bootstrap-kasho.sh not found"
              exit 1
            fi
            
            # Run bootstrap process in a dedicated container
            docker run --rm \
              --network demo_default \
              -e PRIMARY_DATABASE_URL="${{ secrets.PRIMARY_DATABASE_URL }}" \
              -e KV_URL="${{ secrets.KV_URL }}" \
              -e CHANGE_STREAM_SERVICE="pg-change-stream:8080" \
              -e REPLICATION_SLOT_NAME="kasho_slot" \
              -e WAIT_FOR_BOOTSTRAP="true" \
              kasho:prod \
              /app/scripts/bootstrap-kasho.sh
            
            echo "‚úÖ Bootstrap process completed successfully"

  deployment-status:
    runs-on: ubuntu-latest
    needs: [check-changes, deploy]
    if: always()
    steps:
      - name: Deployment Status
        run: |
          echo "üìä Deployment Status Report"
          echo "=========================="
          echo "Tests passed: ${{ github.event.workflow_run.conclusion == 'success' }}"
          echo "Changes detected: ${{ needs.check-changes.outputs.should-deploy }}"
          echo "Deployment job status: ${{ needs.deploy.result }}"
          
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "‚ùå Deployment skipped: Tests failed"
          elif [[ "${{ needs.check-changes.outputs.should-deploy }}" != "true" ]]; then
            echo "‚è≠Ô∏è Deployment skipped: No relevant changes detected"
          elif [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ Deployment completed successfully"
          else
            echo "‚ùå Deployment failed"
          fi