name: Deploy Demo Environment

on:
  workflow_run:
    workflows: ["Test Suite"]
    types:
      - completed
    branches:
      - main

jobs:
  check-changes:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.demo }}
    steps:
      - uses: actions/checkout@v4
      - name: Check for relevant changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            demo:
              - 'environments/demo/**'
              - 'tools/**'
              - 'services/**'
              - '.github/workflows/deploy-demo.yml'

  deploy:
    needs: check-changes
    if: ${{ github.event.workflow_run.conclusion == 'success' && needs.check-changes.outputs.should-deploy == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log deployment start
        run: |
          echo "ðŸš€ Starting deployment to DigitalOcean..."
          echo "Tests passed: ${{ github.event.workflow_run.conclusion == 'success' }}"
          echo "Should deploy: ${{ needs.check-changes.outputs.should-deploy }}"
      
      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd ~
            if [ ! -d "kasho" ]; then
              git clone ${{ secrets.REPO_URL }} kasho
            fi
            cd kasho
            git fetch --all
            git reset --hard origin/main
            git pull -f
            
            # Build the kasho image for production
            docker build -t kasho --target production .
            
            cd environments/demo
            
            # Create .env file from secrets
            cat > .env << EOL
            CHANGE_STREAM_HOST=${{ secrets.CHANGE_STREAM_HOST }}
            CHANGE_STREAM_PORT=${{ secrets.CHANGE_STREAM_PORT }}
            TRANSFORM_CONFIG_FILE=${{ secrets.TRANSFORM_CONFIG_FILE }}
            
            PRIMARY_DATABASE_SU_USER=${{ secrets.PRIMARY_DATABASE_SU_USER }}
            PRIMARY_DATABASE_SU_PASSWORD=${{ secrets.PRIMARY_DATABASE_SU_PASSWORD }}
            PRIMARY_DATABASE_KASHO_USER=${{ secrets.PRIMARY_DATABASE_KASHO_USER }}
            PRIMARY_DATABASE_KASHO_PASSWORD=${{ secrets.PRIMARY_DATABASE_KASHO_PASSWORD }}
            PRIMARY_DATABASE_HOST=${{ secrets.PRIMARY_DATABASE_HOST }}
            PRIMARY_DATABASE_PORT=${{ secrets.PRIMARY_DATABASE_PORT }}
            PRIMARY_DATABASE_DB=${{ secrets.PRIMARY_DATABASE_DB }}
            PRIMARY_DATABASE_SSLMODE=${{ secrets.PRIMARY_DATABASE_SSLMODE }}
            
            REPLICA_DATABASE_SU_USER=${{ secrets.REPLICA_DATABASE_SU_USER }}
            REPLICA_DATABASE_SU_PASSWORD=${{ secrets.REPLICA_DATABASE_SU_PASSWORD }}
            REPLICA_DATABASE_KASHO_USER=${{ secrets.REPLICA_DATABASE_KASHO_USER }}
            REPLICA_DATABASE_KASHO_PASSWORD=${{ secrets.REPLICA_DATABASE_KASHO_PASSWORD }}
            REPLICA_DATABASE_HOST=${{ secrets.REPLICA_DATABASE_HOST }}
            REPLICA_DATABASE_PORT=${{ secrets.REPLICA_DATABASE_PORT }}
            REPLICA_DATABASE_DB=${{ secrets.REPLICA_DATABASE_DB }}
            REPLICA_DATABASE_SSLMODE=${{ secrets.REPLICA_DATABASE_SSLMODE }}
            EOL
            
            docker compose down -v
            docker compose up --build -d
            
            # Wait for services to be ready
            sleep 10
            
            # Run setup scripts
            cd ../..
            ./scripts/setup-replication.sh demo
            ./scripts/demo-fake-projmgmt-saas.sh demo

  deployment-status:
    runs-on: ubuntu-latest
    needs: [check-changes, deploy]
    if: always()
    steps:
      - name: Deployment Status
        run: |
          echo "ðŸ“Š Deployment Status Report"
          echo "=========================="
          echo "Tests passed: ${{ github.event.workflow_run.conclusion == 'success' }}"
          echo "Changes detected: ${{ needs.check-changes.outputs.should-deploy }}"
          echo "Deployment job status: ${{ needs.deploy.result }}"
          
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "âŒ Deployment skipped: Tests failed"
          elif [[ "${{ needs.check-changes.outputs.should-deploy }}" != "true" ]]; then
            echo "â­ï¸ Deployment skipped: No relevant changes detected"
          elif [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… Deployment completed successfully"
          else
            echo "âŒ Deployment failed"
          fi